\chapter{Implementacja systemu}


\section{Analiza faz cyklu oddechowego na podstawie wykresu têtna}

\subsection{Wprowadzenie}
System zaprojektowano do okreœlania faz oddechu na podstawie zmian w têtnie. Silny efekt RSA powodowa³ wzrost mocy sygna³u w tym samym paœmie czêstotliwoœci, co dominuj¹ca czêstotliwoœæ rytmu oddechowego w danej próbce. Na przyk³ad dla osoby oddychaj¹cej w tempie 12 cykli na minutê (0.2 Hz), wysoki poziom mocy sygna³u w tej czêstotliwoœci wskazywa³ na intensywny efekt RSA. 

Aby precyzyjnie okreœliæ fazy oddechu, konieczne by³o wykrywanie lokalnych ekstremów w sygnale têtna. Minima odpowiada³y pocz¹tkom wdechu, a maksima pocz¹tkom wydechu.

\subsection{Przetwarzanie sygna³u za pomoc¹ filtru pasmowego}
W celu identyfikacji tych zmian, sygna³ têtna zosta³ przetworzony za pomoc¹ cyfrowego filtru pasmowego w konfiguracji bez przesuniêcia fazowego, wykorzystuj¹c funkcjê \texttt{filtfilt} z biblioteki \texttt{scipy.signal}. Filtr pasmowy zosta³ zoptymalizowany pod k¹tem czêstotliwoœci oddechu  osoby badanej. Zastosowano filtr Butterwortha 4. rzêdu, zapewniaj¹cy odpowiedni¹ równowagê miêdzy stromoœci¹ charakterystyki a stabilnoœci¹ przetwarzanego sygna³u. Nale¿y jednak zauwa¿yæ, ¿e zastosowanie filtra 4. rzêdu powoduje znacz¹ce opóŸnienie w przetwarzaniu sygna³u. W konsekwencji prawid³owe dzia³anie algorytmu wymaga uwzglêdnienia co najmniej 28 próbek interwa³ów RR, aby unikn¹æ zniekszta³ceñ wynikaj¹cych z niewystarczaj¹cego buforowania danych.

Filtr Butterwortha w konfiguracji pasmowo-przepustowej przepuszcza³ tylko czêstotliwoœci w zakresie okreœlonym parametrami \textit{low} i \textit{high}, znormalizowanym wzglêdem czêstotliwoœci Nyquista (65 Hz dla czêstotliwoœci próbkowania 130 Hz). 

\subsection{Dobór parametrów filtru}
Eksperymenty, których wyniki szczegó³owo omówiono w dalszej czêœci pracy, wykaza³y, ¿e najlepsze wyniki uzyskano, gdy filtr przepuszcza³ czêstotliwoœci od 80-krotnoœci do 200-krotnoœci czêstotliwoœci oddechu.
Przyk³adowo, dla osoby oddychaj¹cej z czêstotliwoœci¹ oko³o 6 oddechów na minutê (0.1 Hz), optymalne pasmo filtru wynosi³o od 8 Hz do 20 Hz. Aby osi¹gn¹æ takie ustawienia, parametry \textit{low} i \textit{high} nale¿y odpowiednio ustawiæ na wartoœci 8 i 20 Hz. Zakres ten zapewnia³ wyraŸne lokalne ekstrema w przefiltrowanym sygnale têtna, umo¿liwiaj¹c dok³adne okreœlenie faz oddechu.


Opisywany algorytm wykazywa³ jednak pewne ograniczenia, szczególnie w przypadku szybszych oddechów (o czêstotliwoœci powy¿ej 0,25 Hz). Ponadto, w obecnej implementacji wymaga³ on filtrowania ca³ego sygna³u, co w trybie rzeczywistym lub podczas analizy du¿ych próbek danych, znacz¹co zwiêksza³o obci¹¿enie obliczeniowe.

\subsection{Detekcja szczytów lokalnych i analiza faz oddechowych}

Do identyfikacji lokalnych szczytów w sygnale wykorzystano funkcjê \texttt{find\_peaks} z biblioteki \texttt{scipy.signal}. W parametrach funkcji zdefiniowano próg (\textit{threshold}) jako œredni¹ wartoœæ przefiltrowanego sygna³u powiêkszon¹ o 10\% odchylenia standardowego, co okreœla³o minimalny poziom, powy¿ej którego poszukiwano szczytów. Dodatkowo, ustawiono minimaln¹ odleg³oœæ (\textit{distance}) miêdzy kolejnymi szczytami jako liczbê próbek odpowiadaj¹c¹ czasowi trwania po³owy jednego cyklu oddechowego. 

W celu detekcji do³ków sygna³ zosta³ odwrócony poprzez zmianê znaku wszystkich próbek, a nastêpnie zastosowano te same procedury co w przypadku wykrywania szczytów. Proces detekcji uzupe³niono o autorski algorytm korekcji pozycji wykrytych ekstremów wzglêdem sygna³u nieprzefiltrowanego, co opisano szczegó³owo w Rozdziale 2 w kontekœcie algorytmu Pan-Tompkinsa.

Wyznaczone ekstrema oznaczono na wykresie têtna kolorami: minima jako zielone punkty, a maksima jako czerwone punkty. Na podstawie wykrytych ekstremów zaimplementowano algorytm identyfikuj¹cy momenty trwania poszczególnych wdechów i wydechów. Wdech zdefiniowano jako fragment sygna³u rozpoczynaj¹cy siê w minimum wykresu têtna i koñcz¹cy siê w kolejnym maksimum, pod warunkiem, ¿e pomiêdzy tymi punktami nie wystêpowa³y dodatkowe minima. Analogicznie, wydech okreœlono jako fragment rozpoczynaj¹cy siê w maksimum i koñcz¹cy w kolejnym minimum.

Przyjête podejœcie zapewnia odpornoœæ na sytuacje, w których algorytm nie wykry³by niektórych minimów lub maksimów. Na przyk³ad brak detekcji koñca fazy oddechowej móg³by prowadziæ do sztucznego wyd³u¿enia czasu jej trwania. Dziêki zdefiniowanym regu³om minimalizowano wp³yw takich przypadków na wyniki analizy.

Na podstawie wykrytych wdechów i wydechów obliczono kluczowe wskaŸniki. Pierwszym z nich jest RSA Index, zdefiniowany jako ró¿nica miêdzy najd³u¿szym a najkrótszym interwa³em RR w ca³ym sygnale. Drugim wskaŸnikiem jest œrednia ró¿nica w d³ugoœci interwa³u RR miêdzy pocz¹tkiem a koñcem zarówno wdechu, jak i wydechu. WskaŸnik ten jest kluczowym parametrem opisuj¹cym si³ê efektu RSA.



\subsection{Przyk³ad zastosowania algorytmu}
Na rysunku przedstawiono wyniki analizy sygna³u EKG zarejestrowanego na odcinku 118 sekund, podczas którego osoba oddycha³a ze sta³¹ czêstotliwoœci¹ 0,07 Hz (œrednio 14 sekund na cykl oddechowy). Wykresy zosta³y wygenerowane przy u¿yciu opisywanej aplikacji i uporz¹dkowane w czterech rzêdach:

\begin{figure}[ht]
    \centering
    \includegraphics[scale=0.25]{Rysunki/oddechy.png}
    \caption{Analiza sygna³u EKG: wykryte szczyty R, ró¿nice interwa³ów RR, przebieg têtna i jego przefiltrowany sygna³.}
    \label{fig/oddechy}
\end{figure}

\begin{itemize}
    \item Pierwszy rz¹d: Wartoœci napiêcia (w \textmu{}V) dla wykrytych szczytów R w czasie, wyznaczone za pomoc¹ algorytmu Pan-Tompkinsa.
    \item Drugi rz¹d: Ró¿nice miêdzy kolejnymi interwa³ami RR (w sekundach) w funkcji czasu.
    \item Trzeci rz¹d: Przebieg têtna (w uderzeniach na minutê) z zaznaczonymi minimami i maksimami zgodnie z opisanymi kryteriami.
    \item Czwarty rz¹d: Przefiltrowany sygna³ têtna (w jednostkach znormalizowanych) w funkcji czasu.
\end{itemize}


\subsection{Podsumowanie wyników}
Na podstawie analizy sygna³u aplikacja wyznaczy³a nastêpuj¹ce miary charakterystyczne:
\begin{itemize}
    \item Œredni czas trwania wdechu: 9,99 s,
    \item Œredni czas trwania wydechu: 4,25 s,
    \item {RSA Index}: Maksymalna ró¿nica d³ugoœci interwa³ów RR w ca³ym sygnale wynosi³a 0,48 s,
    \item {Mean RR Interval Difference}: Œrednia ró¿nica d³ugoœci interwa³ów RR miêdzy pocz¹tkiem a koñcem faz oddechu wynosi³a 0,35 s,
    \item Œrednia d³ugoœæ pe³nego cyklu oddechowego: 14,24 s.
\end{itemize}

Wyniki wskazuj¹ na wyraŸn¹ przewagê d³ugoœci wdechu nad d³ugoœci¹ wydechu. Zjawisko to zosta³o dok³adniej opisane w kolejnym rozdziale.


\section{Analiza sygna³u EKG za pomoc¹ transformacji Fouriera}

\subsection{Interpolacja i spe³nienie warunku Nyquista}
W celu analizy sygna³u EKG przy u¿yciu szybkiej transformacji Fouriera (FFT) obejmuj¹cej czêstotliwoœci w zakresie 0,04–0,4 Hz, konieczne by³o przekszta³cenie nierównomiernie próbkowanego sygna³u RR w równomierny. W tym celu zastosowano interpolacjê liniow¹ interwa³ów RR z czêstotliwoœci¹ próbkowania 4 Hz. Dziêki temu spe³niono warunek Nyquista, poniewa¿ najwiêksza analizowana czêstotliwoœæ (0,4 Hz) le¿y poni¿ej po³owy czêstotliwoœci próbkowania (2 Hz).

\subsection{Przygotowanie sygna³u do analizy}
Przed wykonaniem transformacji na sygna³ na³o¿ono okno Hanninga. Okno to redukuje amplitudy na pocz¹tku i koñcu sygna³u, co pozwala na wyg³adzenie danych i minimalizacjê efektów nieci¹g³oœci. Nastêpnie wykonano dyskretn¹ transformacjê Fouriera, która przekszta³ca sygna³ z dziedziny czasu do dziedziny czêstotliwoœci. 

W wyniku FFT uzyskano dwa wektory:
\begin{itemize}
    \item \texttt{fft\_result} – zawieraj¹cy informacje o amplitudach i fazach sk³adowych czêstotliwoœciowych,
    \item \texttt{freqs} – wskazuj¹cy czêstotliwoœci odpowiadaj¹ce poszczególnym wartoœciom w \texttt{fft\_result}.
\end{itemize}

\subsection{Obliczanie mocy w pasmach czêstotliwoœci}
Moc sygna³u w okreœlonych pasmach, takich jak LF czy HF, obliczono jako ca³kê z kwadratu modu³u amplitud \(|FFT|^2\) w odpowiednim przedziale czêstotliwoœci. W praktyce odpowiada to sumie wartoœci mocy przypisanych do tych czêstotliwoœci:
\[
\text{Power} = \int_{f_1}^{f_2} |FFT(f)|^2 df.
\]
Dziêki temu mo¿liwe by³o zwizualizowanie mocy w ca³ym zakresie czêstotliwoœci, jak równie¿ w wybranych pasmach, a tak¿e obliczanie stosunku LF/HF. 

\subsection{Ograniczenia i uwagi dotycz¹ce metody FFT}
Transformacja FFT wymaga dostêpu do ca³ego sygna³u, co oznacza, ¿e analiza w czasie rzeczywistym jest obarczona opóŸnieniem wynikaj¹cym z czasu potrzebnego na zebranie danych i przeprowadzenie obliczeñ.

\subsection{Wyniki analizy FFT}
Poni¿ej zamieszczono wynik szybkiej transformaty Fouriera który zosta³ wygenerowany przy u¿yciu modu³u implementowanego w ramach stworzonej aplikacji. Na wykresie przedstawiono widmow¹ gêstoœæ mocy (Power Spectral Density, PSD), wyra¿on¹ w jednostkach \([ms^2/Hz]\), w dziedzinie czêstotliwoœci. Analiza zosta³a wykonana na sygnale z 5-minutowego badania przeprowadzonego podczas snu.


\subsection{Wizualizacja wyników}
Na wykresie uwidoczniono wartoœci mocy w poszczególnych pasmach czêstotliwoœci: LF, HF oraz stosunek LF/HF. Zauwa¿alna jest dominuj¹ca moc w paœmie ULF (Ultra-Low Frequency, poni¿ej 0,003 Hz).
\begin{figure}
    \centering
    \includegraphics[scale=0.25]{Rysunki/fftFAR.png}
    \caption{Widmowa gêstoœæ mocy (PSD) dla 5-minutowego badania.}
    \label{fig:fft_psd}
\end{figure}

Na kolejnym wykresie, bêd¹cym przybli¿eniem rozk³adu gêstoœci mocy tego samego sygna³u, widoczne s¹ lokalne wzrosty mocy w paœmie czêstotliwoœci \(0,28\ \text{Hz}\) (HF) oraz mniejszy, ale wyraŸny wzrost dla czêstotliwoœci \(0,09\ \text{Hz}\) (LF).
\begin{figure}
    \centering
    \includegraphics[scale=0.25]{Rysunki/fftCLOSE.png}
    \caption{Przybli¿enie rozk³adu gêstoœci mocy w pasmach LF i HF.}
    \label{fig:fft_zoomed}
\end{figure}


\section{Analiza czasowo-czêstotliwoœciowa}

W analizie czasowo-czêstotliwoœciowej, równie¿ zastosowano interpolacjê interwa³ów RR do czêstotliwoœci 4 Hz, aby zapewniæ równomierne próbkowanie sygna³u. Do analizy wykorzystano sinusoidaln¹ falkê Morleta, która jest szczególnie dobrze dopasowana do sygna³ów harmonicznych, takich jak RSA. 

\subsection{Parametry analizy falkowej}
Falka Morleta, zaimplementowana przy u¿yciu biblioteki PyWavelets, umo¿liwia precyzyjn¹ analizê w interesuj¹cym zakresie czêstotliwoœci. Kluczowe parametry falki zosta³y dostosowane w nastêpuj¹cy sposób:
\begin{itemize}
    \item \textbf{Szerokoœæ pasma:} \(B = 15\), co dziêki stosunkowo wysokiej wartoœci zwiêksza precyzjê w dziedzinie czêstotliwoœci, jednoczeœnie zachowuj¹c odpowiedni kompromis z rozdzielczoœci¹ czasow¹,
    \item \textbf{Czêstotliwoœæ centralna:} \(C = 0.22\), która skupia energiê falki na kluczowym dla analizy przedziale czêstotliwoœci.
\end{itemize}

\subsection{Wyznaczanie mocy sygna³u}
Stworzono funkcjê obliczaj¹c¹ parametr \textit{scales}, czyli poziomy skalowania funkcji falkowej, odpowiadaj¹ce analizowanemu zakresowi czêstotliwoœci (0,03–0,5 Hz). Parametr ten pozwala³ dostosowaæ analizê do wybranych czêstotliwoœci, umo¿liwiaj¹c transformacjê falkow¹ sygna³u i uzyskanie wspó³czynników (\textit{coefficients}), które wskazuj¹, jak mocno sygna³ pasuje do falki w danym momencie i dla danej skali. Na tej podstawie liczona by³a moc sygna³u jako suma kwadratów amplitud:
\[
|C(a,b)|^2,
\]
co pozwala³o wizualizowaæ zmiany mocy na skalogramie.

\subsection{Problemy brzegowe i wizualizacja wyników}
Zawy¿one wartoœci mocy na krañcach dziedziny czasowej wynika³y z efektów brzegowych – falka czêœciowo wykracza³a poza sygna³, co prowadzi³o do zniekszta³ceñ. W celu poprawy widocznoœci zmian na skalogramie przedstawiono zlogarytmowan¹ moc w formie kolorowej mapy w uk³adzie czas-czêstotliwoœæ.

Program umo¿liwia równie¿ obliczanie mocy sygna³u w wybranych pasmach czêstotliwoœci (np. LF lub HF) oraz wizualizacjê ich zmian, a tak¿e ich stosunku \textit{LF/HF} w czasie. Wszystkie te funkcjonalnoœci dzia³aj¹ zarówno podczas analizy sygna³u w czasie rzeczywistym, jak i podczas analizy danych wczytywanych z pliku.

Ze wzglêdu na specyfikê dzia³ania transformacji falkowej, która mo¿e generowaæ zniekszta³cenia na granicach sygna³u w dziedzinie czasowej, moc obliczana jest dla ca³ego zakresu czasowego jednoczeœnie. Mo¿e to prowadziæ do opóŸnieñ, zw³aszcza w przypadku analizy w czasie rzeczywistym lub przetwarzania sygna³ów o du¿ej d³ugoœci.

\subsection{Wyniki analizy}
Na zamieszczonym obrazie przeanalizowano tê sam¹ 5-minutow¹ próbkê zarejestrowan¹ podczas snu, która by³a omówiona w rozdziale dotycz¹cym implementacji FFT. Przedstawione wykresy, wygenerowane za pomoc¹ aplikacji stworzonej w ramach niniejszej pracy, obrazuj¹:
\begin{itemize}
    \item {Pierwszy rz¹d:} Skalogram, na którym logarytmowana moc sygna³u jest zobrazowana kolorami zgodnie z legend¹, w zale¿noœci od czêstotliwoœci (oœ Y) i czasu (oœ X).
    \item {Drugi rz¹d:} Zmiany mocy w czasie dla pasm HF i LF, oznaczone zgodnie z opisami w legendzie.
    \item {Trzeci rz¹d:} Stosunek mocy pasm HF do LF w funkcji czasu.
\end{itemize}

Warto zwróciæ uwagê na zawy¿one wartoœci mocy na krañcach analizowanego okresu.

\begin{figure}
    \centering
    \includegraphics[scale=0.25]{Rysunki/waveFAR.png}
    \caption{Wyniki analizy czasowo-czêstotliwoœciowej dla 5-minutowej próbki sygna³u.}

    \label{fig:wave_normal}
\end{figure}

Na kolejnym wycinku zaprezentowano te same wykresy, przybli¿one do zakresu od 30. do 270. sekundy. Przybli¿enie to pozwala wyeliminowaæ zniekszta³cenia spowodowane efektem brzegowym analizy falkowej, co zapewnia bardziej precyzyjn¹ wizualizacjê danych. W analizowanym zakresie zauwa¿alna jest dominacja mocy w przedziale czêstotliwoœci \(0,2\text{--}0,3\ \text{Hz}\) (pasmo HF) w stosunku do pasma LF. Zale¿noœæ tê wyraŸnie pokazuj¹ zarówno skalogram, jak i wykresy mocy obu pasm oraz ich stosunku.

\begin{figure}
    \centering
    \includegraphics[scale=0.25]{Rysunki/waveCLOSE.png}
    \caption{Przybli¿enie analizy czasowo-czêstotliwoœciowej w ograniczonym zakresie czasu, bez widocznych efektów brzegowych.}
    \label{fig:wave_zoomed}
\end{figure}



% \section{}
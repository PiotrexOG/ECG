\chapter{Implementacja systemu}

\section{Aplikacja g˜˜wna}
\subsection{Tryby pracy aplikacji}
Aplikacja oferuje trzy tryby pracy: normalny, symulacji oraz ˜adowania danych z
pliku. Niezale˜nie od wybranego trybu, aplikacja zapewnia te same podstawowe
funkcje. W ka˜dym z tryb˜w odbywa si˜ rysowanie wykresu sygna˜u EKG, wykrywanie
szczyt˜w R, obliczanie miar HRV oraz prezentacja wynik˜w. Miary czasowe takie
jak SDNN, RMSSD, MEAN RR czy PNN50 oraz cz˜stotliwo˜ciowe jak LF, HF czy ich
stosuenk s˜ obliczane na podstawie odst˜p˜w RR i wy˜wietlane u˜ytkownikowi, a
wykres sygna˜u jest na bie˜˜co aktualizowany lub generowany po zako˜czeniu
analizy.

W trybie normalnym aplikacja dzia˜a w czasie rzeczywistym, odbieraj˜c dane z
urz˜dzenia Polar H10 za po˜rednictwem aplikacji po˜rednicz˜cej. Po otwarciu
portu komunikacyjnego kolejne pakiety danych s˜ przetwarzane na bie˜˜co, co
umo˜liwia rysowanie wykresu sygna˜u EKG oraz dynamiczne obliczanie miar HRV w
momencie ich nap˜ywu. Wyniki s˜ regularnie aktualizowane i prezentowane
u˜ytkownikowi w czasie rzeczywistym. W trybie normalnym aplikacja wykorzystuje
dwa w˜tki do efektywnej obs˜ugi danych
\begin{enumerate}
    \item W˜tek odbieraj˜cy dane - odpowiedzialny za odbieranie pakiet˜w danych z
          urz˜dzenia oraz ich zapisywanie w odpowiedniej strukturze danych.
    \item W˜tek przetwarzaj˜cy dane - zajmuje si˜ analiz˜ odebranych danych, w tym
          wykrywaniem szczyt˜w R oraz obliczaniem miar HRV.
\end{enumerate}
Aby unikn˜˜ konflikt˜w w dost˜pie do wsp˜dzielonych zasob˜w mi˜dzy
w˜tkami, zastosowano mechanizm synchronizacji oparty na semaforach. W tym celu
wykorzystano obiekt \emph{Lock} z modu˜u \emph{threading}, kt˜ry umo˜liwia kontrol˜ dost˜pu
do wsp˜dzielonych zmiennych i zasob˜w. Dzi˜ki zastosowaniu tego rozwi˜zania
dane s˜ przetwarzane w spos˜b sp˜jny i bezpieczny

Tryb symulacji dzia˜a podobnie do trybu normalnego, z t˜ r˜nic˜, ˜e dane nie
s˜ odbierane z zewn˜trznego ˜r˜d˜a, lecz wczytywane z pliku. Za obs˜ug˜ tego
procesu odpowiada dedykowany w˜tek aplikacji, kt˜ry odczytuje sygna˜, dzieli go
na pakiety i przesy˜a na odpowiedni port aplikacji. Takie podej˜cie umo˜liwia
przetwarzanie danych w spos˜b symuluj˜cy rzeczywisty nap˜yw informacji. Dzi˜ki
temu mo˜na testowa˜ algorytmy w kontrolowanych warunkach na wcze˜niej zebranych
danych, co pozwala na ich dok˜adn˜ weryfikacj˜ i optymalizacj˜ przed
zastosowaniem w trybie rzeczywistym.

W trybie ˜adowania danych z pliku aplikacja wczytuje ca˜y zapis sygna˜u EKG
jednorazowo i przetwarza go w ca˜o˜ci. Analiza obejmuje pe˜ny zestaw danych,
bez ich dzielenia na pakiety. Po zako˜czeniu przetwarzania u˜ytkownik otrzymuje
wykres obrazuj˜cy pe˜ny przebieg sygna˜u oraz zestaw obliczonych miar HRV. W
tym trybie dost˜pne s˜ trzy opcje ˜adowania plik˜w: wczytanie pliku CSV
zawieraj˜cego dane z czujnika Polar H10 w formacie "timestamp-warto˜˜",
za˜adowanie danych pacjenta ze zbioru MIT-BIH oraz z bazy QT.

\subsection{Komponent odpowiedzialny za znajdowanie szczyt˜w R}
Aplikacja wykorzystuje dedykowany komponent do lokalizowania szczyt˜w R w
sygnale EKG, kt˜rego implementacja jest w pe˜ni modu˜owa i elastyczna.
Komponent ten, zwany ˜detektorem szczyt˜w˜, jest wstrzykiwany jako parametr
konstruktora do obiektu odpowiedzialnego za przechowywanie i analiz˜ danych
EKG. Dzi˜ki temu mo˜liwa jest ˜atwa wymiana lub dostosowanie algorytmu detekcji
w zale˜no˜ci od potrzeb i specyfikacji analizy. U˜ywany rodzaj detektora
szczyt˜w zale˜y od wybranego algorytmu detekcji w pliku konfiguracyjnym. Ka˜dy
znajdywacz implementuje wsp˜lny interfejs, co zapewnia jednolit˜ struktur˜ i
transparentno˜˜ dzia˜ania niezale˜nie od zastosowanego algorytmu. Interfejs
definiuje zestaw metod, kt˜re znajdywacz musi zaimplementowa˜, w tym kluczow˜
metod˜ s˜u˜˜c˜ do lokalizowania szczyt˜w w przekazanym fragmencie sygna˜u. Taka
architektura pozwala na ˜atw˜ integracj˜ nowych algorytm˜w bez konieczno˜ci
modyfikowania pozosta˜ych element˜w systemu.

\subsection{Mechanizm dodawania szczyt˜w R w czasie rzeczywistym}
Aplikacja rozpoczyna proces wykrywania szczyt˜w R dopiero po zgromadzeniu co
najmniej dwusekundowego fragmentu sygna˜u EKG. Po spe˜nieniu tego warunku, przy
ka˜dym odebraniu nowych danych, system przechodzi do analizy fragmentu sygna˜u
zaczynaj˜c od ostatnio wykrytego szczytu R. Je˜li do tej pory nie
zidentyfikowano ˜adnego szczytu, analiza rozpoczyna si˜ od pocz˜tku sygna˜u.
Fragment sygna˜u przekazywany jest do komponentu odpowiedzialnego za
identyfikacj˜ szczyt˜w R. Po ich wykryciu, aplikacja zapisuje jedynie te, kt˜re
s˜ oddalone od ko˜ca przekazanego przedzia˜u o co najmniej po˜ow˜ ˜redniej
r˜nicy mi˜dzy trzema wcze˜niej wykrytymi szczytami R. Mechanizm ten zapobiega
b˜˜dnemu rozpoznaniu szczyt˜w w przypadkach, gdy sygna˜ ko˜czy si˜ na zboczu
fali R, uniemo˜liwiaj˜c algorytmowi poprawne okre˜lenie jego maksymalnej
warto˜ci. Takie podej˜cie pozwala na uzyskanie wi˜kszej precyzji w detekcji
szczyt˜w i minimalizuje ryzyko b˜˜d˜w wynikaj˜cych z niepe˜nych danych. Bez
opisanego podej˜cia do nowo-wykrytych szczyt˜w dochodzi˜o do sytuacji w kt˜rych
szczyt oznaczany by˜ na rosn˜cym zboczu za˜amka R, a nie jego szczycie.

\subsection{Ocena wynik˜w wykrywania szczyt˜w R}
Ocena skuteczno˜ci wykrywania szczyt˜w R w sygnale EKG opiera si˜ na
klasycznych metrykach u˜ywanych w analizie danych: czu˜o˜ci, precyzji i
F1-score. Metryki te s˜ wyliczane na podstawie liczby TP (True Positive), FP
(False Positive) i FN (False Negative). Szczyty wykryte przez algorytm
klasyfikowane s˜ jako TP, je˜li znajduj˜ si˜ w odleg˜o˜ci maksymalnie 50 ms od
pozycji referencyjnej.

Tolerancja 20 ms zosta˜a wprowadzona po zauwa˜eniu, ˜e w zbiorach danych
referencyjnych, takich jak MIT-BIH, pozycje szczyt˜w R nie zawsze s˜ oznaczone
z dok˜adno˜ci˜ co do milisekundy. Wcze˜niejsze testy wykaza˜y, ˜e bez
zastosowania tej tolerancji znaczna cz˜˜ (nawet ponad po˜owa) poprawnie
wykrytych szczyt˜w by˜a b˜˜dnie klasyfikowana jako FP, co znacz˜co zani˜a
warto˜ci obliczanych metryk. Tolerancja ta pozwala na bardziej realistyczn˜
ocen˜ dzia˜ania algorytmu.

\begin{figure}[ht]
    \centering
    \includegraphics[scale=0.5]{Rysunki/temp.PNG}
    \caption{Wykres przedstawiaj˜cy r˜nice miedzy wykrytymi a za˜adowanymi szczytami}
    % \caption*{˜r˜d˜o:  \url{https://www.researchgate.net/figure/Normal-ECG-signal-with-his-different-features_fig1_299575422} [Data uzyskania dost˜pu 02.11.2024]}
    \label{fig/ekgGraph}
\end{figure}

\subsection{Mechanizm dzielenia sygna˜u na okna}
W celu u˜atwienia analizy i przygotowania danych do treningu modeli uczenia
maszynowego zaimplementowano mechanizm dzielenia sygna˜u EKG na okna o
okre˜lonym rozmiarze. Dla wyznaczonych okien mo˜na wyznaczano parametry takie
jak SDNN, RMSDD, LF, HF, LF/HF. jest tablica indeks˜w wykrytych szczyt˜w R oraz
tablica binarna, w kt˜rej ka˜da warto˜˜ sygna˜u oznaczona jest jako ˜1˜ (je˜li
reprezentuje szczyt) lub ˜0˜ (je˜li nie). Aby uwzgl˜dni˜ lokalne zmienno˜ci
sygna˜u, za szczyt uznawane s˜ r˜wnie˜ punkty znajduj˜ce si˜ w s˜siedztwie 2
pr˜bek ane w oknach s˜ normalizowane do zakresu od -1 do 1, co zapewnia
sp˜jno˜˜ analizy oraz kompatybilno˜˜ z modelami uczenia maszynowego.

Miary s˜ obliczane zar˜wno dla szczyt˜w za˜adowanych z danych referencyjnych,
jak i dla szczyt˜w wykrytych przez zastosowany algorytm. To podej˜cie umo˜liwia
bezpo˜rednie por˜wnanie wynik˜w analizy mi˜dzy r˜nymi ˜r˜d˜ami.

\subsection{Mechanizm event˜w i dynamicznej aktualizacji}
System zosta˜ wyposa˜ony w mechanizm zdarze˜ (event˜w), kt˜ry umo˜liwia
dynamiczne powiadamianie warstwy prezentacji o zmianach w danych. Gdy wykrywane
s˜ nowe szczyty R lub aktualizowane s˜ warto˜ci miar HRV, mechanizm event˜w
automatycznie wywo˜uje od˜wie˜enie wykres˜w oraz warto˜ci metryk w interfejsie
u˜ytkownika. Pozwala to na p˜ynne monitorowanie wynik˜w w czasie rzeczywistym,
co jest szczeg˜lnie istotne w aplikacjach pracuj˜cych na danych dynamicznie
nap˜ywaj˜cych. Przy wsp˜pracy z urz˜dzeniem Polar H10, wykres ˜rednio
od˜wie˜any jest co 73/130 sekundy. Wynika to ze sposobu przesy˜ania danych
przez urz˜dzenie pomiarowe, kt˜re rejestruje sygna˜ z cz˜stotliwo˜cia
pr˜bkowania 130Hz i wysy˜a je w pakietach zawieraj˜cych 73 pr˜bki sygna˜u.
Mechanizm ka˜dorazowego od˜wie˜ania wykresu przy aktualizacji danych mo˜na
zast˜pi˜ od˜wie˜aniem co dany okres czasu

\subsection{Interpolacja liniowa do wy˜szej cz˜stotliwo˜ci pr˜bkowania}
W celu zapewnienia kompatybilno˜ci z modelami przetrenowanymi na danych o
wy˜szej cz˜stotliwo˜ci pr˜bkowania, zaimplementowano mechanizm interpolacji
liniowej sygna˜u EKG. Wykorzystano do tego funkcj˜ interp1d z modu˜u
scipy.interpolate, kt˜ra umo˜liwia przekszta˜cenie danych o ni˜szej
cz˜stotliwo˜ci (np. z czujnika Polar H10) na wy˜sz˜ cz˜stotliwo˜˜ stosowan˜ w
bazie MIT-BIH. Dzi˜ki temu mo˜liwe jest stosowanie modeli uczonych na danych o
wy˜szej rozdzielczo˜ci do analizy sygna˜˜w o odmiennej cz˜stotliwo˜ci
pr˜bkowania.

Interpolacja poprawia r˜wnie˜ precyzj˜ wykrywania szczyt˜w w
sytuacjach, gdy pierwotna cz˜stotliwo˜˜ pr˜bkowania mog˜aby ogranicza˜
dok˜adno˜˜ analizy. Docelow˜ cz˜stotliwo˜˜ pr˜bkowania, oznaczon˜ jako
TARGE FREQUENCY, mo˜na zdefiniowa˜ w pliku konfiguracyjnym, co pozwala na
elastyczne dostosowanie procesu interpolacji do potrzeb u˜ytkownika.

\section{Analiza faz cyklu oddechowego na podstawie wykresu t˜tna}

\subsection{Wprowadzenie}
System zaprojektowano do okre˜lania faz oddechu na podstawie zmian w t˜tnie.
Silny efekt RSA powodowa˜ wzrost mocy sygna˜u w tym samym pa˜mie
cz˜stotliwo˜ci, co dominuj˜ca cz˜stotliwo˜˜ rytmu oddechowego w danej pr˜bce.
Na przyk˜ad dla osoby oddychaj˜cej w tempie 12 cykli na minut˜ (0.2 Hz), wysoki
poziom mocy sygna˜u w tej cz˜stotliwo˜ci wskazywa˜ na intensywny efekt RSA.

Aby precyzyjnie okre˜li˜ fazy oddechu, konieczne by˜o wykrywanie lokalnych
ekstrem˜w w sygnale t˜tna. Minima odpowiada˜y pocz˜tkom wdechu, a maksima
pocz˜tkom wydechu.

\subsection{Przetwarzanie sygna˜u za pomoc˜ filtru pasmowego}
W celu identyfikacji tych zmian, sygna˜ t˜tna zosta˜ przetworzony za pomoc˜
cyfrowego filtru pasmowego w konfiguracji bez przesuni˜cia fazowego,
wykorzystuj˜c funkcj˜ \texttt{filtfilt} z biblioteki \texttt{scipy.signal}.
Filtr pasmowy zosta˜ zoptymalizowany pod k˜tem cz˜stotliwo˜ci oddechu osoby
badanej. Zastosowano filtr Butterwortha 4. rz˜du, zapewniaj˜cy odpowiedni˜
r˜wnowag˜ mi˜dzy stromo˜ci˜ charakterystyki a stabilno˜ci˜ przetwarzanego
sygna˜u. Nale˜y jednak zauwa˜y˜, ˜e zastosowanie filtra 4. rz˜du powoduje
znacz˜ce op˜nienie w przetwarzaniu sygna˜u. W konsekwencji prawid˜owe
dzia˜anie algorytmu wymaga uwzgl˜dnienia co najmniej 28 pr˜bek interwa˜˜w RR,
aby unikn˜˜ zniekszta˜ce˜ wynikaj˜cych z niewystarczaj˜cego buforowania danych.

Filtr Butterwortha w konfiguracji pasmowo-przepustowej przepuszcza˜ tylko
cz˜stotliwo˜ci w zakresie okre˜lonym parametrami \textit{low} i \textit{high},
znormalizowanym wzgl˜dem cz˜stotliwo˜ci Nyquista (65 Hz dla cz˜stotliwo˜ci
pr˜bkowania 130 Hz).

\subsection{Dob˜r parametr˜w filtru}
Eksperymenty, kt˜rych wyniki szczeg˜owo om˜wiono w dalszej cz˜ci pracy,
wykaza˜y, ˜e najlepsze wyniki uzyskano, gdy filtr przepuszcza˜ cz˜stotliwo˜ci
od 80-krotno˜ci do 200-krotno˜ci cz˜stotliwo˜ci oddechu. Przyk˜adowo, dla osoby
oddychaj˜cej z cz˜stotliwo˜ci˜ oko˜o 6 oddech˜w na minut˜ (0.1 Hz), optymalne
pasmo filtru wynosi˜o od 8 Hz do 20 Hz. Aby osi˜gn˜˜ takie ustawienia,
parametry \textit{low} i \textit{high} nale˜y odpowiednio ustawi˜ na warto˜ci 8
i 20 Hz. Zakres ten zapewnia˜ wyra˜ne lokalne ekstrema w przefiltrowanym
sygnale t˜tna, umo˜liwiaj˜c dok˜adne okre˜lenie faz oddechu.

Opisywany algorytm wykazywa˜ jednak pewne ograniczenia, szczeg˜lnie w przypadku
szybszych oddech˜w (o cz˜stotliwo˜ci powy˜ej 0,25 Hz). Ponadto, w obecnej
implementacji wymaga˜ on filtrowania ca˜ego sygna˜u, co w trybie rzeczywistym
lub podczas analizy du˜ych pr˜bek danych, znacz˜co zwi˜ksza˜o obci˜˜enie
obliczeniowe.

\subsection{Detekcja szczyt˜w lokalnych i analiza faz oddechowych}

Do identyfikacji lokalnych szczyt˜w w sygnale wykorzystano funkcj˜
\texttt{find\_peaks} z biblioteki \texttt{scipy.signal}. W parametrach funkcji
zdefiniowano pr˜g (\textit{threshold}) jako ˜redni˜ warto˜˜ przefiltrowanego
sygna˜u powi˜kszon˜ o 10\% odchylenia standardowego, co okre˜la˜o minimalny
poziom, powy˜ej kt˜rego poszukiwano szczyt˜w. Dodatkowo, ustawiono minimaln˜
odleg˜o˜˜ (\textit{distance}) mi˜dzy kolejnymi szczytami jako liczb˜ pr˜bek
odpowiadaj˜c˜ czasowi trwania po˜owy jednego cyklu oddechowego.

W celu detekcji do˜k˜w sygna˜ zosta˜ odwr˜cony poprzez zmian˜ znaku wszystkich
pr˜bek, a nast˜pnie zastosowano te same procedury co w przypadku wykrywania
szczyt˜w. Proces detekcji uzupe˜niono o autorski algorytm korekcji pozycji
wykrytych ekstrem˜w wzgl˜dem sygna˜u nieprzefiltrowanego, co opisano
szczeg˜owo w Rozdziale 2 w kontek˜cie algorytmu Pan-Tompkinsa.

Wyznaczone ekstrema oznaczono na wykresie t˜tna kolorami: minima jako zielone
punkty, a maksima jako czerwone punkty. Na podstawie wykrytych ekstrem˜w
zaimplementowano algorytm identyfikuj˜cy momenty trwania poszczeg˜lnych wdech˜w
i wydech˜w. Wdech zdefiniowano jako fragment sygna˜u rozpoczynaj˜cy si˜ w
minimum wykresu t˜tna i ko˜cz˜cy si˜ w kolejnym maksimum, pod warunkiem, ˜e
pomi˜dzy tymi punktami nie wyst˜powa˜y dodatkowe minima. Analogicznie, wydech
okre˜lono jako fragment rozpoczynaj˜cy si˜ w maksimum i ko˜cz˜cy w kolejnym
minimum.

Przyj˜te podej˜cie zapewnia odporno˜˜ na sytuacje, w kt˜rych algorytm nie
wykry˜by niekt˜rych minim˜w lub maksim˜w. Na przyk˜ad brak detekcji ko˜ca fazy
oddechowej m˜g˜by prowadzi˜ do sztucznego wyd˜u˜enia czasu jej trwania. Dzi˜ki
zdefiniowanym regu˜om minimalizowano wp˜yw takich przypadk˜w na wyniki analizy.

Na podstawie wykrytych wdech˜w i wydech˜w obliczono kluczowe wska˜niki.
Pierwszym z nich jest RSA Index, zdefiniowany jako r˜nica mi˜dzy najd˜u˜szym a
najkr˜tszym interwa˜em RR w ca˜ym sygnale. Drugim wska˜nikiem jest ˜rednia
r˜nica w d˜ugo˜ci interwa˜u RR mi˜dzy pocz˜tkiem a ko˜cem zar˜wno wdechu, jak
i wydechu. Wska˜nik ten jest kluczowym parametrem opisuj˜cym si˜˜ efektu RSA.

\subsection{Przyk˜ad zastosowania algorytmu}
Na rysunku przedstawiono wyniki analizy sygna˜u EKG zarejestrowanego na odcinku
118 sekund, podczas kt˜rego osoba oddycha˜a ze sta˜˜ cz˜stotliwo˜ci˜ 0,07 Hz
(˜rednio 14 sekund na cykl oddechowy). Wykresy zosta˜y wygenerowane przy u˜yciu
opisywanej aplikacji i uporz˜dkowane w czterech rz˜dach:

\begin{figure}[ht]
    \centering
    \includegraphics[scale=0.25]{Rysunki/oddechy.png}
    \caption{Analiza sygna˜u EKG: wykryte szczyty R, r˜nice interwa˜˜w RR, przebieg t˜tna i jego przefiltrowany sygna˜.}
    \label{fig/oddechy}
\end{figure}

\begin{itemize}
    \item Pierwszy rz˜d: Warto˜ci napi˜cia (w \textmu{}V) dla wykrytych szczyt˜w R w
          czasie, wyznaczone za pomoc˜ algorytmu Pan-Tompkinsa.
    \item Drugi rz˜d: R˜nice mi˜dzy kolejnymi interwa˜ami RR (w sekundach) w funkcji
          czasu.
    \item Trzeci rz˜d: Przebieg t˜tna (w uderzeniach na minut˜) z zaznaczonymi minimami i
          maksimami zgodnie z opisanymi kryteriami.
    \item Czwarty rz˜d: Przefiltrowany sygna˜ t˜tna (w jednostkach znormalizowanych) w
          funkcji czasu.
\end{itemize}

\subsection{Podsumowanie wynik˜w}
Na podstawie analizy sygna˜u aplikacja wyznaczy˜a nast˜puj˜ce miary
charakterystyczne:
\begin{itemize}
    \item ˜redni czas trwania wdechu: 9,99 s,
    \item ˜redni czas trwania wydechu: 4,25 s,
    \item {RSA Index}: Maksymalna r˜nica d˜ugo˜ci interwa˜˜w RR w ca˜ym sygnale wynosi˜a 0,48 s,
    \item {Mean RR Interval Difference}: ˜rednia r˜nica d˜ugo˜ci interwa˜˜w RR mi˜dzy pocz˜tkiem a ko˜cem faz oddechu wynosi˜a 0,35 s,
    \item ˜rednia d˜ugo˜˜ pe˜nego cyklu oddechowego: 14,24 s.
\end{itemize}

Wyniki wskazuj˜ na wyra˜n˜ przewag˜ d˜ugo˜ci wdechu nad d˜ugo˜ci˜ wydechu.
Zjawisko to zosta˜o dok˜adniej opisane w kolejnym rozdziale.

\section{Analiza sygna˜u EKG za pomoc˜ transformacji Fouriera}

\subsection{Interpolacja i spe˜nienie warunku Nyquista}
W celu analizy sygna˜u EKG przy u˜yciu szybkiej transformacji Fouriera (FFT)
obejmuj˜cej cz˜stotliwo˜ci w zakresie 0,04˜0,4 Hz, konieczne by˜o
przekszta˜cenie nier˜wnomiernie pr˜bkowanego sygna˜u RR w r˜wnomierny. W tym
celu zastosowano interpolacj˜ liniow˜ interwa˜˜w RR z cz˜stotliwo˜ci˜
pr˜bkowania 4 Hz. Dzi˜ki temu spe˜niono warunek Nyquista, poniewa˜ najwi˜ksza
analizowana cz˜stotliwo˜˜ (0,4 Hz) le˜y poni˜ej po˜owy cz˜stotliwo˜ci
pr˜bkowania (2 Hz).

\subsection{Przygotowanie sygna˜u do analizy}
Przed wykonaniem transformacji na sygna˜ na˜o˜ono okno Hanninga. Okno to
redukuje amplitudy na pocz˜tku i ko˜cu sygna˜u, co pozwala na wyg˜adzenie
danych i minimalizacj˜ efekt˜w nieci˜g˜o˜ci. Nast˜pnie wykonano dyskretn˜
transformacj˜ Fouriera, kt˜ra przekszta˜ca sygna˜ z dziedziny czasu do
dziedziny cz˜stotliwo˜ci.

W wyniku FFT uzyskano dwa wektory:
\begin{itemize}
    \item \texttt{fft\_result} ˜ zawieraj˜cy informacje o amplitudach i fazach sk˜adowych cz˜stotliwo˜ciowych,
    \item \texttt{freqs} ˜ wskazuj˜cy cz˜stotliwo˜ci odpowiadaj˜ce poszczeg˜lnym warto˜ciom w \texttt{fft\_result}.
\end{itemize}

\subsection{Obliczanie mocy w pasmach cz˜stotliwo˜ci}
Moc sygna˜u w okre˜lonych pasmach, takich jak LF czy HF, obliczono jako ca˜k˜ z
kwadratu modu˜u amplitud \(|FFT|^2\) w odpowiednim przedziale cz˜stotliwo˜ci. W
praktyce odpowiada to sumie warto˜ci mocy przypisanych do tych cz˜stotliwo˜ci:
\[
    \text{Power} = \int_{f_1}^{f_2} |FFT(f)|^2 df.
\]
Dzi˜ki temu mo˜liwe by˜o zwizualizowanie mocy w ca˜ym zakresie cz˜stotliwo˜ci,
jak r˜wnie˜ w wybranych pasmach, a tak˜e obliczanie stosunku LF/HF.

\subsection{Ograniczenia i uwagi dotycz˜ce metody FFT}
Transformacja FFT wymaga dost˜pu do ca˜ego sygna˜u, co oznacza, ˜e analiza w
czasie rzeczywistym jest obarczona op˜nieniem wynikaj˜cym z czasu potrzebnego
na zebranie danych i przeprowadzenie oblicze˜.

\subsection{Wyniki analizy FFT}
Poni˜ej zamieszczono wynik szybkiej transformaty Fouriera kt˜ry zosta˜
wygenerowany przy u˜yciu modu˜u implementowanego w ramach stworzonej aplikacji.
Na wykresie przedstawiono widmow˜ g˜sto˜˜ mocy (Power Spectral Density, PSD),
wyra˜on˜ w jednostkach \([ms^2/Hz]\), w dziedzinie cz˜stotliwo˜ci. Analiza
zosta˜a wykonana na sygnale z 5-minutowego badania przeprowadzonego podczas
snu.

\subsection{Wizualizacja wynik˜w}
Na wykresie uwidoczniono warto˜ci mocy w poszczeg˜lnych pasmach cz˜stotliwo˜ci:
LF, HF oraz stosunek LF/HF. Zauwa˜alna jest dominuj˜ca moc w pa˜mie ULF
(Ultra-Low Frequency, poni˜ej 0,003 Hz).
\begin{figure}
    \centering
    \includegraphics[scale=0.25]{Rysunki/fftFAR.png}
    \caption{Widmowa g˜sto˜˜ mocy (PSD) dla 5-minutowego badania.}
    \label{fig:fft_psd}
\end{figure}

Na kolejnym wykresie, b˜d˜cym przybli˜eniem rozk˜adu g˜sto˜ci mocy tego samego
sygna˜u, widoczne s˜ lokalne wzrosty mocy w pa˜mie cz˜stotliwo˜ci \(0,28\
\text{Hz}\) (HF) oraz mniejszy, ale wyra˜ny wzrost dla cz˜stotliwo˜ci \(0,09\
\text{Hz}\) (LF).
\begin{figure}
    \centering
    \includegraphics[scale=0.25]{Rysunki/fftCLOSE.png}
    \caption{Przybli˜enie rozk˜adu g˜sto˜ci mocy w pasmach LF i HF.}
    \label{fig:fft_zoomed}
\end{figure}

\section{Analiza czasowo-cz˜stotliwo˜ciowa}

W analizie czasowo-cz˜stotliwo˜ciowej, r˜wnie˜ zastosowano interpolacj˜
interwa˜˜w RR do cz˜stotliwo˜ci 4 Hz, aby zapewni˜ r˜wnomierne pr˜bkowanie
sygna˜u. Do analizy wykorzystano sinusoidaln˜ falk˜ Morleta, kt˜ra jest
szczeg˜lnie dobrze dopasowana do sygna˜˜w harmonicznych, takich jak RSA.

\subsection{Parametry analizy falkowej}
Falka Morleta, zaimplementowana przy u˜yciu biblioteki PyWavelets, umo˜liwia
precyzyjn˜ analiz˜ w interesuj˜cym zakresie cz˜stotliwo˜ci. Kluczowe parametry
falki zosta˜y dostosowane w nast˜puj˜cy spos˜b:
\begin{itemize}
    \item \textbf{Szeroko˜˜ pasma:} \(B = 15\), co dzi˜ki stosunkowo wysokiej warto˜ci zwi˜ksza precyzj˜ w dziedzinie cz˜stotliwo˜ci, jednocze˜nie zachowuj˜c odpowiedni kompromis z rozdzielczo˜ci˜ czasow˜,
    \item \textbf{Cz˜stotliwo˜˜ centralna:} \(C = 0.22\), kt˜ra skupia energi˜ falki na kluczowym dla analizy przedziale cz˜stotliwo˜ci.
\end{itemize}

\subsection{Wyznaczanie mocy sygna˜u}
Stworzono funkcj˜ obliczaj˜c˜ parametr \textit{scales}, czyli poziomy
skalowania funkcji falkowej, odpowiadaj˜ce analizowanemu zakresowi
cz˜stotliwo˜ci (0,03˜0,5 Hz). Parametr ten pozwala˜ dostosowa˜ analiz˜ do
wybranych cz˜stotliwo˜ci, umo˜liwiaj˜c transformacj˜ falkow˜ sygna˜u i
uzyskanie wsp˜czynnik˜w (\textit{coefficients}), kt˜re wskazuj˜, jak mocno
sygna˜ pasuje do falki w danym momencie i dla danej skali. Na tej podstawie
liczona by˜a moc sygna˜u jako suma kwadrat˜w amplitud:
\[
    |C(a,b)|^2,
\]
co pozwala˜o wizualizowa˜ zmiany mocy na skalogramie.

\subsection{Problemy brzegowe i wizualizacja wynik˜w}
Zawy˜one warto˜ci mocy na kra˜cach dziedziny czasowej wynika˜y z efekt˜w
brzegowych ˜ falka cz˜ciowo wykracza˜a poza sygna˜, co prowadzi˜o do
zniekszta˜ce˜. W celu poprawy widoczno˜ci zmian na skalogramie przedstawiono
zlogarytmowan˜ moc w formie kolorowej mapy w uk˜adzie czas-cz˜stotliwo˜˜.

Program umo˜liwia r˜wnie˜ obliczanie mocy sygna˜u w wybranych pasmach
cz˜stotliwo˜ci (np. LF lub HF) oraz wizualizacj˜ ich zmian, a tak˜e ich
stosunku \textit{LF/HF} w czasie. Wszystkie te funkcjonalno˜ci dzia˜aj˜ zar˜wno
podczas analizy sygna˜u w czasie rzeczywistym, jak i podczas analizy danych
wczytywanych z pliku.

Ze wzgl˜du na specyfik˜ dzia˜ania transformacji falkowej, kt˜ra mo˜e generowa˜
zniekszta˜cenia na granicach sygna˜u w dziedzinie czasowej, moc obliczana jest
dla ca˜ego zakresu czasowego jednocze˜nie. Mo˜e to prowadzi˜ do op˜nie˜,
zw˜aszcza w przypadku analizy w czasie rzeczywistym lub przetwarzania sygna˜˜w
o du˜ej d˜ugo˜ci.

\subsection{Wyniki analizy}
Na zamieszczonym obrazie przeanalizowano t˜ sam˜ 5-minutow˜ pr˜bk˜
zarejestrowan˜ podczas snu, kt˜ra by˜a om˜wiona w rozdziale dotycz˜cym
implementacji FFT. Przedstawione wykresy, wygenerowane za pomoc˜ aplikacji
stworzonej w ramach niniejszej pracy, obrazuj˜:
\begin{itemize}
    \item {Pierwszy rz˜d:} Skalogram, na kt˜rym logarytmowana moc sygna˜u jest zobrazowana kolorami zgodnie z legend˜, w zale˜no˜ci od cz˜stotliwo˜ci (o˜ Y) i czasu (o˜ X).
    \item {Drugi rz˜d:} Zmiany mocy w czasie dla pasm HF i LF, oznaczone zgodnie z opisami w legendzie.
    \item {Trzeci rz˜d:} Stosunek mocy pasm HF do LF w funkcji czasu.
\end{itemize}

Warto zwr˜ci˜ uwag˜ na zawy˜one warto˜ci mocy na kra˜cach analizowanego okresu.

\begin{figure}
    \centering
    \includegraphics[scale=0.25]{Rysunki/waveFAR.png}
    \caption{Wyniki analizy czasowo-cz˜stotliwo˜ciowej dla 5-minutowej pr˜bki sygna˜u.}

    \label{fig:wave_normal}
\end{figure}

Na kolejnym wycinku zaprezentowano te same wykresy, przybli˜one do zakresu od
30. do 270. sekundy. Przybli˜enie to pozwala wyeliminowa˜ zniekszta˜cenia
spowodowane efektem brzegowym analizy falkowej, co zapewnia bardziej precyzyjn˜
wizualizacj˜ danych. W analizowanym zakresie zauwa˜alna jest dominacja mocy w
przedziale cz˜stotliwo˜ci \(0,2\text{--}0,3\ \text{Hz}\) (pasmo HF) w stosunku
do pasma LF. Zale˜no˜˜ t˜ wyra˜nie pokazuj˜ zar˜wno skalogram, jak i wykresy
mocy obu pasm oraz ich stosunku.

\begin{figure}
    \centering
    \includegraphics[scale=0.25]{Rysunki/waveCLOSE.png}
    \caption{Przybli˜enie analizy czasowo-cz˜stotliwo˜ciowej w ograniczonym zakresie czasu, bez widocznych efekt˜w brzegowych.}
    \label{fig:wave_zoomed}
\end{figure}

\section{Implementacja i Wizualizacja ˜redniej Krocz˜cej}

Na podstawie poni˜szego wykresu, przedstawiaj˜cego rozk˜ad mocy w dziedzinie
czasu i cz˜stotliwo˜ci, wyznaczonego na podstawie sygna˜u EKG za pomoc˜ analizy
falkowej dla okresu 3,5 godziny, zostanie opisana implementacja i wizualizacja
˜redniej krocz˜cej.

\begin{figure}
    \centering
    \includegraphics[scale=0.4]{Rysunki/wavePORANEK.png}
    \caption{Skalogram przedstawiaj˜cy rozk˜ad mocy w dziedzinie czasu i cz˜stotliwo˜ci dla sygna˜u EKG uzyskany za pomoc˜ analizy falkowej.}
    \label{fig:wavePORANEK}
\end{figure}

W przypadku analizy mocy w pasmach LF i HF oraz ich stosunku w tak d˜ugim
przedziale czasowym, wykres tych warto˜ci mo˜e by˜ ma˜o czytelny z uwagi na
du˜˜ zmienno˜˜ mocy w poszczeg˜lnych pasmach. W takich sytuacjach, gdy chcemy
zobrazowa˜ globalne trendy, warto zastosowa˜ metod˜ statystyczn˜, jak˜ jest
˜rednia krocz˜ca. Na rysunku poni˜ej przedstawiono moc w pa˜mie LF dla
analizowanego sygna˜u.

\begin{figure}
    \centering
    \includegraphics[scale=0.4]{Rysunki/lf_avg.png}
    \caption{Zastosowanie r˜nych metod ˜redniej krocz˜cej do wyg˜adzania mocy w pa˜mie LF, przedstawiaj˜ce ich wp˜yw na odwzorowanie trend˜w w d˜u˜szej perspektywie czasowej.}
    \label{fig:lf_avg}
\end{figure}

Subteln˜, r˜ow˜ lini˜ zilustrowano wykres mocy w pa˜mie LF z dok˜adno˜ci˜ do
0,25 sekundy. Ze wzgl˜du na du˜e wahania mocy w kr˜tkich odst˜pach czasu,
analiza tego wykresu w d˜u˜szej perspektywie jest trudna. Dlatego liniami o
r˜nych kolorach zaprezentowano zastosowanie centralnej ˜redniej krocz˜cej dla
okna o rozmiarze 900 sekund (15 minut). Linie przedstawiaj˜:
\begin{itemize}
    \item ˜redni˜ jednorodn˜ (kolor niebieski),
    \item ˜redni˜ liniow˜ (kolor zielony),
    \item ˜redni˜ gaussowsk˜ (kolor czerwony).
\end{itemize}

W d˜u˜szym przedziale czasowym wszystkie te ˜rednie wykazuj˜ zbli˜one warto˜ci,
jednak po zmniejszeniu skali mo˜na zaobserwowa˜ subtelne r˜nice, co ilustruje
poni˜szy wykres:

\begin{figure}
    \centering
    \includegraphics[scale=0.4]{Rysunki/lf_compare_avg.png}
    \caption{R˜nice w wyg˜adzaniu mocy w pa˜mie LF dla metod jednorodnej, liniowej i gaussowskiej, przy mniejszej skali czasowej.}
    \label{fig:lf_compare_avg}
\end{figure}

W przypadku ˜redniej jednorodnej (kolor niebieski) lokalne ekstrema s˜ bardziej
wyg˜adzone ni˜ w przypadku ˜redniej liniowej i gaussowskiej, kt˜rych warto˜ci
niemal si˜ pokrywaj˜. Filtr gaussowski zapewnia jednak bardziej naturalne
wyg˜adzenie, szczeg˜lnie przy analizie dynamicznych sygna˜˜w lub kr˜tszych
okien czasowych. Na podstawie tego por˜wnania oraz teoretycznych przes˜anek
opisanych we wcze˜niejszym rozdziale, wybrano ˜redni˜ gaussowsk˜ jako domy˜lny
spos˜b prezentowania zmian w czasie, z mo˜liwo˜ci˜ dostosowania rozmiaru okna
przez u˜ytkownika w pliku konfiguracyjnym.

Poni˜szy wykres przedstawia zmiany mocy w pasmach HF i LF w czasie, z
zastosowaniem ˜redniej krocz˜cej z filtrem Gaussa:

\begin{figure}
    \centering
    \includegraphics[scale=0.4]{Rysunki/lf_hf_normal.png}
    \caption{Wykres zmian mocy w pasmach LF i HF w czasie, z zastosowaniem ˜redniej krocz˜cej z filtrem Gaussa.}
    \label{fig:lf_hf_normal}
\end{figure}

W przypadku poprawnego zobrazowania zmienno˜ci stosunku mocy w pasmach LF/HF
mo˜liwe jest zastosowanie r˜nych podej˜˜. Na wykresie poni˜ej pokazano zmiany
tego stosunku w czasie

\begin{figure}
    \centering
    \includegraphics[scale=0.4]{Rysunki/lf_hf_avg_ratio.png}
    \caption{Por˜wnanie dw˜ch podej˜˜ do prezentacji stosunku mocy w pasmach LF i HF.}
    \label{fig:lf_hf_avg_ratio}
\end{figure}

gdzie:
\begin{itemize}
    \item Zielon˜ lini˜ zilustrowano iloraz warto˜ci u˜rednionej mocy w pa˜mie LF oraz
          u˜rednionej mocy w pa˜mie HF dla ka˜dego momentu \( t \).
    \item ˜˜t˜ lini˜ przedstawiono iloraz rzeczywistej warto˜ci mocy w pa˜mie LF do warto˜ci mocy w pa˜mie HF dla chwili \( t \), a nast˜pnie wynikow˜ seri˜ danych poddano u˜rednianiu krocz˜cemu.
\end{itemize}

Wida˜, ˜e stosunek tych dw˜ch miar jest silniej zale˜ny od chwilowych du˜ych
zmian w warto˜ciach w drugim podej˜ciu, co utrudnia analiz˜ trend˜w w d˜u˜szej
perspektywie. Dlatego system domy˜lnie wykorzystuje pierwsze podej˜cie do
prezentacji stosunku LF/HF w czasie.

System umo˜liwia implementacj˜ centralnej ˜redniej krocz˜cej wy˜˜cznie dla
danych wczytanych w ca˜o˜ci, np. z pliku CSV. Taka ˜rednia mo˜e by˜ stosowana
jedynie do wykres˜w opartych na kompletnych danych, gdzie dla ka˜dego
analizowanego punktu istnieje odpowiednia liczba pr˜bek zar˜wno z jego lewej,
jak i prawej strony. W przypadku analizy danych w czasie rzeczywistym, gdzie
przysz˜e warto˜ci s˜ nieznane, tego rodzaju u˜rednianie w tej implementacji nie
jest wspierane. W takiej sytuacji stosuje si˜ ˜rednie oparte wy˜˜cznie na
danych historycznych, co powoduje przesuni˜cie (tzw. lag) wzgl˜dem
rzeczywistego sygna˜u. W d˜u˜szym okresie przesuni˜cie to ma jednak niewielki
wp˜yw na og˜ln˜ analiz˜.

Funkcjonalno˜˜ obliczania ˜redniej krocz˜cej, zar˜wno centralnej, jak i
klasycznej, zosta˜a r˜wnie˜ zaimplementowana w przypadku wizualizacji trend˜w
pulsu oraz interwa˜˜w RR, z u˜yciem filtra gaussowskiego.

% \section{}